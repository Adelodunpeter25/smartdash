{% extends "base.html" %}

{% block title %}SmartDash - To-Do List{% endblock %}

{% block content %}
<div class="todo-container">
  <h2>To-Do List</h2>
  <form method="post" class="todo-form" id="todo-form">
    {% csrf_token %}
    <input type="hidden" name="todo_id" id="todo_id" value="">
    <input type="text" name="content" id="todo_content" placeholder="Add a new task..." required />
    <input type="datetime-local" name="due_date" id="todo_due_date" placeholder="Due date" />
    <select name="priority" id="todo_priority">
      <option value="low">Low</option>
      <option value="medium" selected>Medium</option>
      <option value="high">High</option>
    </select>
    <input type="hidden" name="is_completed" id="todo_is_completed" value="">
    <textarea name="description" id="todo_description" placeholder="Description (optional)" rows="2" style="flex:1; min-width:120px;"></textarea>
    <button type="submit">Save</button>
    <button type="button" id="newTodoBtn">New</button>
  </form>
  <ul class="todo-list" id="todo-list">
    {% for todo in todos %}
      <li data-id="{{ todo.id }}" data-content="{{ todo.content|escapejs }}" data-completed="{{ todo.is_completed|yesno:'true,false' }}" data-due="{{ todo.due_date|date:'Y-m-d\TH:i' }}" data-priority="{{ todo.priority }}" data-description="{{ todo.description|escapejs }}" class="{% if todo.is_completed %}completed{% endif %}">
        <div class="todo-content">
          <input type="checkbox" class="todo-complete" {% if todo.is_completed %}checked{% endif %} aria-label="Mark complete">
          <span><strong>{{ todo.content }}</strong></span>
          {% if todo.due_date %}<span class="todo-due">Due: {{ todo.due_date|date:'M d, Y H:i' }}</span>{% endif %}
          <span class="todo-priority priority-{{ todo.priority }}">{{ todo.priority|capfirst }}</span>
        </div>
        {% if todo.description %}<div class="todo-desc">{{ todo.description }}</div>{% endif %}
        <div class="todo-actions">
          <button type="button" class="todo-edit">Edit</button>
          <button type="button" class="todo-delete">Delete</button>
        </div>
      </li>
    {% empty %}
      <li>No to-do items yet.</li>
    {% endfor %}
  </ul>
</div>
<script>
const todoList = document.getElementById('todo-list');
const todoIdInput = document.getElementById('todo_id');
const todoContentInput = document.getElementById('todo_content');
const todoIsCompletedInput = document.getElementById('todo_is_completed');
const todoDueDateInput = document.getElementById('todo_due_date');
const todoPriorityInput = document.getElementById('todo_priority');
const todoDescriptionInput = document.getElementById('todo_description');
const newTodoBtn = document.getElementById('newTodoBtn');
const todoForm = document.getElementById('todo-form');

function setIsCompletedField(checked) {
  todoIsCompletedInput.value = checked ? 'on' : '';
}

todoList.addEventListener('click', function(e) {
  const li = e.target.closest('li[data-id]');
  if (!li) return;
  if (e.target.classList.contains('todo-edit')) {
    todoIdInput.value = li.getAttribute('data-id');
    todoContentInput.value = li.getAttribute('data-content');
    todoDueDateInput.value = li.getAttribute('data-due') || '';
    todoPriorityInput.value = li.getAttribute('data-priority') || 'medium';
    todoDescriptionInput.value = li.getAttribute('data-description') || '';
    const completed = li.getAttribute('data-completed') === 'true';
    setIsCompletedField(completed);
    const formCheckbox = todoForm.querySelector('.todo-complete');
    if (formCheckbox) formCheckbox.checked = completed;
  } else if (e.target.classList.contains('todo-delete')) {
    if (!confirm('Delete this to-do item?')) return;
    fetch(`/todo/delete/${li.getAttribute('data-id')}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Accept': 'application/json',
      },
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.error || 'Failed to delete to-do.');
      }
    });
  } else if (e.target.classList.contains('todo-complete')) {
    todoIdInput.value = li.getAttribute('data-id');
    todoContentInput.value = li.getAttribute('data-content');
    todoDueDateInput.value = li.getAttribute('data-due') || '';
    todoPriorityInput.value = li.getAttribute('data-priority') || 'medium';
    todoDescriptionInput.value = li.getAttribute('data-description') || '';
    setIsCompletedField(e.target.checked);
    todoForm.submit();
  }
});

todoForm.addEventListener('submit', function(e) {
  const formCheckbox = todoForm.querySelector('.todo-complete');
  if (formCheckbox) setIsCompletedField(formCheckbox.checked);
});

newTodoBtn.addEventListener('click', function() {
  todoIdInput.value = '';
  todoContentInput.value = '';
  todoDueDateInput.value = '';
  todoPriorityInput.value = 'medium';
  todoDescriptionInput.value = '';
  setIsCompletedField(false);
  const formCheckbox = todoForm.querySelector('.todo-complete');
  if (formCheckbox) formCheckbox.checked = false;
});

// Browser Notification for Due Tasks
function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission !== 'granted') {
    Notification.requestPermission();
  }
}
function showDueTaskNotification(task) {
  if ('Notification' in window && Notification.permission === 'granted') {
    const body = (task.description ? task.description + '\n' : '') + (task.due ? 'Due: ' + task.due : '');
    new Notification('Task Due: ' + task.content, {
      body: body,
      icon: '/static/images/smartdash.ico',
      tag: 'todo-due-' + task.id
    });
  }
}
function checkDueTasks() {
  const now = new Date();
  document.querySelectorAll('#todo-list li[data-due]:not(.completed)').forEach(li => {
    const due = li.getAttribute('data-due');
    if (!due) return;
    const dueDate = new Date(due);
    // Show notification if due within the last 2 minutes or now
    if (dueDate <= now && dueDate > new Date(now.getTime() - 2 * 60 * 1000)) {
      showDueTaskNotification({
        id: li.getAttribute('data-id'),
        content: li.getAttribute('data-content'),
        description: li.getAttribute('data-description'),
        due: dueDate.toLocaleString()
      });
    }
  });
}
requestNotificationPermission();
window.addEventListener('DOMContentLoaded', function() {
  checkDueTasks();
  setInterval(checkDueTasks, 60000); // Check every minute
});
</script>
{% endblock %} 